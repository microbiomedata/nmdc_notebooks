name: Reusable R Notebook Testing Workflow

on:
  workflow_call:
    inputs:
      notebook_selection:
        description: 'How to select notebooks (all or changed)'
        required: false
        default: 'all'
        type: string
      notebooks_json:
        description: 'JSON array of notebooks to test (used when notebook_selection=changed)'
        required: false
        default: '[]'
        type: string
      base_sha:
        description: 'Base SHA for change detection (used when notebook_selection=changed)'
        required: false
        type: string
      head_sha:
        description: 'Head SHA for change detection (used when notebook_selection=changed)'
        required: false
        type: string

jobs:
  detect-notebooks:
    runs-on: ubuntu-latest
    outputs:
      notebooks: ${{ steps.set-notebooks.outputs.notebooks }}
      has-notebooks: ${{ steps.set-notebooks.outputs.has-notebooks }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Fetch PR refs if needed
      if: inputs.notebook_selection == 'changed' && inputs.base_sha != '' && inputs.head_sha != ''
      run: |
        # Ensure we have access to both commits
        echo "Fetching commits for comparison..."
        git fetch origin +${{ inputs.base_sha }}:refs/remotes/origin/base || echo "Base SHA fetch failed, continuing..."
        git fetch origin +${{ inputs.head_sha }}:refs/remotes/origin/head || echo "Head SHA fetch failed, continuing..."
        
        # Verify commits are available
        if git cat-file -e "${{ inputs.base_sha }}" && git cat-file -e "${{ inputs.head_sha }}"; then
          echo "Both commits are now available"
        else
          echo "Trying alternative fetch strategy..."
          git fetch --unshallow || echo "Unshallow failed"
          git fetch origin || echo "Origin fetch failed"
        fi

    - name: Set notebooks to test
      id: set-notebooks
      run: |
        # Check if config file exists
        if [ ! -f ".github/notebooks-config.json" ]; then
          echo "ERROR: Configuration file .github/notebooks-config.json not found"
          ls -la .github/
          exit 1
        fi
        
        # Validate JSON syntax
        if ! jq empty .github/notebooks-config.json; then
          echo "ERROR: Invalid JSON in configuration file"
          cat .github/notebooks-config.json
          exit 1
        fi
        
        if [ "${{ inputs.notebook_selection }}" = "all" ]; then
          # Get all R notebooks from config
          notebooks=$(jq -c '.r_notebooks' .github/notebooks-config.json)
          has_notebooks=true
          echo "üìã Testing all R notebooks"
        else
          # Use provided notebooks JSON or detect changes
          if [ "${{ inputs.notebooks_json }}" != "[]" ]; then
            notebooks='${{ inputs.notebooks_json }}'
            has_notebooks=true
            echo "üìã Testing provided R notebooks"
          else
            # Detect changed notebooks
            notebooks="[]"
            has_notebooks=false

            # Validate that we have the required SHAs for change detection
            if [ -z "${{ inputs.base_sha }}" ] || [ -z "${{ inputs.head_sha }}" ]; then
              echo "ERROR: base_sha and head_sha are required for change detection"
              exit 1
            fi

            # Get list of changed files
            echo "Comparing ${{ inputs.base_sha }} to ${{ inputs.head_sha }}"
            changed_files=$(git diff --name-only ${{ inputs.base_sha }} ${{ inputs.head_sha }})
            
            # Check if renv.lock changed (affects all notebooks)
            if echo "$changed_files" | grep -q "renv.lock"; then
              echo "‚úì renv.lock changed - all R notebooks need testing"
              notebooks=$(jq -c '.r_notebooks' .github/notebooks-config.json)
              has_notebooks=true
            else
              # Check each R notebook to see if it changed
              while IFS= read -r notebook_info; do
                name=$(echo "$notebook_info" | cut -d'|' -f1)
                path=$(echo "$notebook_info" | cut -d'|' -f2)
                
                if echo "$changed_files" | grep -q "$path"; then
                  notebooks=$(echo "$notebooks" | jq --arg name "$name" --arg path "$path" '. += [{"name": $name, "path": $path}]')
                  has_notebooks=true
                  echo "‚úì R Notebook $name needs testing"
                fi
              done < <(jq -r '.r_notebooks[] | "\(.name)|\(.path)"' .github/notebooks-config.json)
            fi
          fi
        fi

        # Output results
        echo "notebooks=$(echo "$notebooks" | jq -c .)" >> $GITHUB_OUTPUT
        echo "has-notebooks=$has_notebooks" >> $GITHUB_OUTPUT
        
        # Debug output
        notebook_count=$(echo "$notebooks" | jq length)
        echo "üìä Total R notebooks to test: $notebook_count"

  setup-r:
    runs-on: ubuntu-latest
    needs: detect-notebooks
    if: needs.detect-notebooks.outputs.has-notebooks == 'true'
    outputs:
      os-version: ${{ steps.get-version.outputs.os-version }}
      r-version: ${{ steps.get-version.outputs.r-version }}
    steps:
    - uses: actions/checkout@v4

    - name: Set RENV_PATHS_ROOT
      shell: bash
      run: |
        echo "RENV_PATHS_ROOT=${{ runner.temp }}/renv" >> $GITHUB_ENV

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Jupyter
      run: |
        python -m pip install --upgrade pip
        pip install jupyter

    - name: Cache system packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt
        key: ${{ runner.os }}-apt-packages-r
        restore-keys: |
          ${{ runner.os }}-apt-packages-

    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'
        use-public-rspm: true

    - name: Install system dependencies on Linux
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          make libicu-dev libxml2-dev libssl-dev pandoc \
          librdf0-dev libnode-dev libcurl4-gnutls-dev libpng-dev

    - name: Get R and OS version
      id: get-version
      shell: Rscript {0}
      run: |
        os_version <- sessionInfo()$running
        r_version <- R.Version()$version.string
        cat(paste0("os-version=", os_version), file = Sys.getenv("GITHUB_OUTPUT"), append = TRUE)
        cat("\n", file = Sys.getenv("GITHUB_OUTPUT"), append = TRUE)
        cat(paste0("r-version=", r_version), file = Sys.getenv("GITHUB_OUTPUT"), append = TRUE)

    - name: Cache R packages
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.RENV_PATHS_ROOT }}
          ~/.local/share/renv
        key: ${{ steps.get-version.outputs.os-version }}-${{ steps.get-version.outputs.r-version }}-renv-${{ hashFiles('renv.lock') }}
        restore-keys: |
          ${{ steps.get-version.outputs.os-version }}-${{ steps.get-version.outputs.r-version }}-renv-

    - name: Install R dependencies
      shell: Rscript {0}
      run: |
        # Configure repositories with fallbacks
        options(repos = c(
          CRAN = "https://cloud.r-project.org/",
          BioCsoft = "https://bioconductor.org/packages/release/bioc",
          BioCann = "https://bioconductor.org/packages/release/data/annotation",
          BioCexp = "https://bioconductor.org/packages/release/data/experiment"
        ))
        
        # Set timeout and retry options
        options(timeout = 300)
        options(download.file.method = "libcurl")
        
        # Install renv with retries
        for(i in 1:3) {
          tryCatch({
            install.packages("renv", repos = "https://cloud.r-project.org/")
            break
          }, error = function(e) {
            cat("Attempt", i, "failed:", e$message, "\n")
            if(i == 3) stop(e)
            Sys.sleep(5)
          })
        }
        
        renv::activate()
        
        # Configure renv for flexible package resolution
        Sys.setenv(RENV_CONFIG_PAK_ENABLED = "TRUE")
        Sys.setenv(RENV_CONFIG_INSTALL_VERBOSE = "TRUE")
        
        # Try restore with fallback strategies
        tryCatch({
          # First try: normal restore
          renv::restore(prompt = FALSE)
        }, error = function(e1) {
          cat("Normal restore failed:", e1$message, "\n")
          cat("Trying with BiocManager fallback...\n")
          tryCatch({
            # Install BiocManager with correct version for R 4.4.3
            install.packages("BiocManager", repos = "https://cloud.r-project.org/")
            # Use version 3.18 for R 4.3, or 3.20 for R 4.4+
            r_version <- as.numeric(paste(R.version$major, R.version$minor, sep = "."))
            bioc_version <- if (r_version >= 4.4) "3.20" else "3.18"
            cat("Installing Bioconductor version", bioc_version, "for R", r_version, "\n")
            BiocManager::install(version = bioc_version, ask = FALSE, update = FALSE)
            
            # Try restore again
            renv::restore(prompt = FALSE)
          }, error = function(e2) {
            cat("BiocManager restore failed:", e2$message, "\n")
            cat("Installing core packages manually...\n")
            # Fallback: install critical packages manually
            core_packages <- c("jsonlite", "dplyr", "ggplot2", "tidyr")
            for (pkg in core_packages) {
              tryCatch({
                install.packages(pkg, repos = "https://cloud.r-project.org/")
                cat("Installed", pkg, "\n")
              }, error = function(e) {
                cat("Failed to install", pkg, ":", e$message, "\n")
              })
            }
            
            # Try installing some Bioconductor packages
            tryCatch({
              BiocManager::install(c("BiocGenerics"), ask = FALSE, update = FALSE)
            }, error = function(e3) {
              cat("Warning: Some Bioconductor packages could not be installed\n")
            })
          })
        })
        
        # Install IRkernel
        install.packages("IRkernel", repos = "https://cloud.r-project.org/")
        IRkernel::installspec(name = "ir", displayname = "R")

  execute-notebooks:
    runs-on: ubuntu-latest
    needs: [detect-notebooks, setup-r]
    if: needs.detect-notebooks.outputs.has-notebooks == 'true'
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        notebook: ${{ fromJson(needs.detect-notebooks.outputs.notebooks) }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Set RENV_PATHS_ROOT
      shell: bash
      run: |
        echo "RENV_PATHS_ROOT=${{ runner.temp }}/renv" >> $GITHUB_ENV

    - name: Set up Python (fast)
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Jupyter (cached)
      run: |
        python -m pip install --upgrade pip
        pip install jupyter

    - name: Cache system packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt
        key: ${{ runner.os }}-apt-packages-r
        restore-keys: |
          ${{ runner.os }}-apt-packages-

    - name: Set up R (fast)
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'
        use-public-rspm: true

    - name: Install system dependencies (cached)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          make libicu-dev libxml2-dev libssl-dev pandoc \
          librdf0-dev libnode-dev libcurl4-gnutls-dev libpng-dev

    - name: Restore R package cache (fast)
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.RENV_PATHS_ROOT }}
          ~/.local/share/renv
        key: ${{ needs.setup-r.outputs.os-version }}-${{ needs.setup-r.outputs.r-version }}-renv-${{ hashFiles('renv.lock') }}
        restore-keys: |
          ${{ needs.setup-r.outputs.os-version }}-${{ needs.setup-r.outputs.r-version }}-renv-

    - name: Quick R environment restore
      shell: Rscript {0}
      run: |
        # Configure repositories with fallbacks (use release instead of specific version)
        options(repos = c(
          CRAN = "https://cloud.r-project.org/",
          BioCsoft = "https://bioconductor.org/packages/release/bioc",
          BioCann = "https://bioconductor.org/packages/release/data/annotation",
          BioCexp = "https://bioconductor.org/packages/release/data/experiment"
        ))
        
        # Set timeout and retry options
        options(timeout = 300)
        options(download.file.method = "libcurl")
        
        # Install renv with retries (should be fast from cache)
        for(i in 1:3) {
          tryCatch({
            install.packages("renv", repos = "https://cloud.r-project.org/")
            break
          }, error = function(e) {
            cat("Attempt", i, "failed:", e$message, "\n")
            if(i == 3) stop(e)
            Sys.sleep(5)
          })
        }
        
        renv::activate()
        
        # Configure renv for flexible package resolution
        Sys.setenv(RENV_CONFIG_PAK_ENABLED = "TRUE")
        
        # Quick restore (packages should be cached from setup job)
        tryCatch({
          renv::restore(prompt = FALSE)
        }, error = function(e) {
          cat("Restore failed, but continuing with cached packages...\n")
          cat("Error:", e$message, "\n")
        })
        
        # Install IRkernel
        install.packages("IRkernel", repos = "https://cloud.r-project.org/")
        IRkernel::installspec(name = "ir", displayname = "R")

    - name: Execute notebook
      run: |
        echo "Executing R notebook: ${{ matrix.notebook.path }}"
        set +e  # Don't exit on error immediately
        jupyter nbconvert --execute --to notebook --inplace "${{ matrix.notebook.path }}"
        EXIT_CODE=$?
        set -e  # Re-enable exit on error
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo "‚ùå R Notebook execution failed with exit code $EXIT_CODE"
          echo "FAILED" > results-${{ matrix.notebook.name }}.txt
          exit 1  # Fail this step
        else
          echo "‚úÖ R Notebook executed successfully"
          echo "SUCCESS" > results-${{ matrix.notebook.name }}.txt
        fi

    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: notebook-results-r-${{ matrix.notebook.name }}
        path: results-${{ matrix.notebook.name }}.txt

    - name: Upload notebook
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: result-r-${{ matrix.notebook.name }}
        path: ${{ matrix.notebook.path }}

  check-results:
    runs-on: ubuntu-latest
    needs: [detect-notebooks, execute-notebooks]
    if: always() && needs.detect-notebooks.outputs.has-notebooks == 'true'
    steps:
    - name: Gather all notebook results
      uses: actions/download-artifact@v4
      with:
        path: results/

    - name: Check notebook results
      run: |
        echo "Checking R notebook execution results..."
        
        find results/ -name "results-*.txt" -exec cat {} \;
        
        FAILED_COUNT=$(find results/ -name "results-*.txt" -exec grep -l "FAILED" {} \; | wc -l)
        TOTAL_COUNT=$(find results/ -name "results-*.txt" | wc -l)
        
        echo "Total R notebooks: $TOTAL_COUNT"
        echo "Failed R notebooks: $FAILED_COUNT"
        
        if [ "$FAILED_COUNT" -gt 0 ]; then
          echo "‚ùå $FAILED_COUNT out of $TOTAL_COUNT R notebooks failed execution."
          find results/ -name "results-*.txt" -exec grep -l "FAILED" {} \; | while read file; do
            notebook_name=$(basename "$file" | sed 's/results-\(.*\)\.txt/\1/')
            echo "Failed R notebook: $notebook_name"
          done
          exit 1
        else
          echo "‚úÖ All $TOTAL_COUNT R notebooks executed successfully!"
        fi

  no-notebooks:
    runs-on: ubuntu-latest
    needs: detect-notebooks
    if: needs.detect-notebooks.outputs.has-notebooks == 'false'
    steps:
    - name: No notebooks to test
      run: |
        if [ "${{ inputs.notebook_selection }}" = "changed" ]; then
          echo "‚úÖ No R notebooks were changed. Skipping execution."
        else
          echo "‚ö†Ô∏è No R notebooks found to test."
        fi