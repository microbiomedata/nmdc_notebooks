name: Deploy All Notebooks to GitHub Pages

on:
  workflow_dispatch:
  push:

# Sets permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  setup-python:
    runs-on: ubuntu-latest
    outputs:
      notebooks: ${{ steps.set-notebooks.outputs.notebooks }}
    steps:
    - id: checkout
      uses: actions/checkout@v4

    - id: python-setup
      name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - id: python-dependencies
      name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install jupyter nbconvert

    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - id: set-notebooks
      name: Set Python notebook matrix
      run: |
        # Read notebooks from centralized config file and filter for bioscales only
        notebooks=$(jq -c '[.python_notebooks[] | select(.name == "bioscales")]' .github/notebooks-config.json)
        echo "notebooks=$notebooks" >> $GITHUB_OUTPUT

  setup-r:
    runs-on: ubuntu-latest
    outputs:
      notebooks: ${{ steps.set-notebooks.outputs.notebooks }}
      os-version: ${{ steps.get-version.outputs.os-version }}
      r-version: ${{ steps.get-version.outputs.r-version }}
    steps:
    - id: checkout
      uses: actions/checkout@v4

    - name: Set RENV_PATHS_ROOT
      shell: bash
      run: |
        echo "RENV_PATHS_ROOT=${{ runner.temp }}/renv" >> $GITHUB_ENV

    - id: python-setup
      name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - id: install-jupyter
      name: Install Jupyter
      run: |
        python -m pip install --upgrade pip
        pip install jupyter

    - id: r-setup
      name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'

    - name: Install system dependencies on Linux
      if: runner.os == 'Linux'
      run: sudo apt-get install -y make libicu-dev libxml2-dev libssl-dev pandoc librdf0-dev libnode-dev libcurl4-gnutls-dev libpng-dev

    - name: Install and activate renv
      shell: Rscript {0}
      run: |
        install.packages("renv")
        renv::activate()

    - name: Get R and OS version
      id: get-version
      shell: Rscript {0}
      run: |
        os_version <- sessionInfo()$running
        r_version <- R.Version()$version.string
        cat(paste0("os-version=", os_version), file = Sys.getenv("GITHUB_OUTPUT"), append = TRUE)
        cat("\n", file = Sys.getenv("GITHUB_OUTPUT"), append = TRUE)
        cat(paste0("r-version=", r_version), file = Sys.getenv("GITHUB_OUTPUT"), append = TRUE)

    - name: Restore Renv package cache
      uses: actions/cache@v4
      with:
        path: ${{ env.RENV_PATHS_ROOT }}
        key: ${{ needs.setup.outputs.os-version }}-${{ needs.setup.outputs.r-version }}-8a6894215af13-${{ hashFiles('renv.lock') }}
        restore-keys: |
          ${{ needs.setup.outputs.os-version }}-${{ needs.setup.outputs.r-version }}-8a6894215af13-

    - id: r-dependencies
      name: Install R dependencies
      shell: Rscript {0}
      run: |
        tryCatch({
          install.packages("renv", repos = "https://cloud.r-project.org/")
          renv::restore()
          # IRkernel is specifically excluded from renv.lock but installed here for execution
          install.packages("IRkernel", repos = "https://cloud.r-project.org/")
          IRkernel::installspec(name = "ir", displayname = "R")
        }, error = function(err) {
          cat("ERROR during R dependency installation:\n", err$message)
          stop(err)
        })

    - id: set-notebooks
      name: Set R notebook matrix
      run: |
        # Read notebooks from centralized config file, filter for bioscales, and add "-r" suffix to names
        notebooks=$(jq -c '[.r_notebooks[] | select(.name == "bioscales") | .name = (.name + "-r")]' .github/notebooks-config.json)
        echo "notebooks=$notebooks" >> $GITHUB_OUTPUT

  convert-python-notebooks:
    runs-on: ubuntu-latest
    needs: setup-python
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        notebook: ${{ fromJson(needs.setup-python.outputs.notebooks) }}
      
    steps:
    - id: checkout
      uses: actions/checkout@v4

    - id: python-setup
      name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Restore Python dependencies cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - id: python-dependencies
      name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install jupyter nbconvert

    - id: convert
      name: Convert ${{ matrix.notebook.name }} notebook to HTML
      run: |
        echo "Converting notebook: ${{ matrix.notebook.path }}"
        
        set +e
        # Step 1: Execute the notebook (including all cells)
        jupyter nbconvert --execute --to notebook "${{ matrix.notebook.path }}" --output-dir=executed_notebooks
        
        # Step 2: Convert executed notebook to HTML with tag removal
        executed_notebook="executed_notebooks/$(basename ${{ matrix.notebook.path }})"
        jupyter nbconvert --to html "$executed_notebook" \
          --TagRemovePreprocessor.remove_cell_tags='["hide-cell", "env-setup", "development-only"]' \
          --output-dir=html_output
        EXIT_CODE=$?
        set -e

        if [ $EXIT_CODE -ne 0 ]; then
          echo "Notebook ${{ matrix.notebook.name }} conversion failed."
          echo "FAILED" > results-${{ matrix.notebook.name }}.txt
          exit 1
        else
          echo "Notebook ${{ matrix.notebook.name }} converted successfully."
          echo "SUCCESS" > results-${{ matrix.notebook.name }}.txt
        fi

    - name: Upload HTML artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: html-python-${{ matrix.notebook.name }}
        path: html_output/*.html

    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: notebook-results-python-${{ matrix.notebook.name }}
        path: results-${{ matrix.notebook.name }}.txt

  convert-r-notebooks:
    runs-on: ubuntu-latest
    needs: setup-r
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        notebook: ${{ fromJson(needs.setup-r.outputs.notebooks) }}
    
    steps:
    - id: checkout
      uses: actions/checkout@v4

    - name: Set RENV_PATHS_ROOT
      shell: bash
      run: |
        echo "RENV_PATHS_ROOT=${{ runner.temp }}/renv" >> $GITHUB_ENV

    - id: python-setup
      name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - id: install-jupyter
      name: Install Jupyter
      run: |
        python -m pip install --upgrade pip
        pip install jupyter

    - id: r-setup
      name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'

    - name: Install system dependencies on Linux
      if: runner.os == 'Linux'
      run: sudo apt-get install -y make libicu-dev libxml2-dev libssl-dev pandoc librdf0-dev libnode-dev libcurl4-gnutls-dev libpng-dev

    - name: Restore Renv package cache
      uses: actions/cache@v4
      with:
        path: ${{ env.RENV_PATHS_ROOT }}
        key: ${{ needs.setup-r.outputs.os-version }}-${{ needs.setup-r.outputs.r-version }}-8a6894215af13-${{ hashFiles('renv.lock') }}
        restore-keys: |
          ${{ needs.setup-r.outputs.os-version }}-${{ needs.setup-r.outputs.r-version }}-8a6894215af13-

    - name: Install and restore R environment
      shell: Rscript {0}
      run: |
        tryCatch({
          install.packages("renv", repos = "https://cloud.r-project.org/")
          renv::activate()
          renv::restore()
          # IRkernel is specifically excluded from renv.lock but installed here for execution
          install.packages("IRkernel", repos = "https://cloud.r-project.org/")
          IRkernel::installspec(name = "ir", displayname = "R")
        }, error = function(err) {
          cat("ERROR during R environment setup:\n", err$message)
          stop(err)
        })

    - id: convert
      name: Convert ${{ matrix.notebook.name }} notebook to HTML
      run: |
        echo "Converting notebook: ${{ matrix.notebook.path }}"
        
        if [ ! -f "${{ matrix.notebook.path }}" ]; then
          echo "ERROR: Notebook file not found: ${{ matrix.notebook.path }}"
          echo "FAILED" > results-${{ matrix.notebook.name }}.txt
          exit 1
        fi
        
        # Step 1: Execute the notebook (including all cells)
        if jupyter nbconvert --execute --to notebook "${{ matrix.notebook.path }}" --output-dir=executed_notebooks; then
          # Step 2: Convert executed notebook to HTML with tag removal
          executed_notebook="executed_notebooks/$(basename ${{ matrix.notebook.path }})"
          if jupyter nbconvert --to html "$executed_notebook" \
             --TagRemovePreprocessor.remove_cell_tags='["hide-cell", "env-setup", "development-only"]' \
             --output-dir=html_output; then
            echo "SUCCESS" > results-${{ matrix.notebook.name }}.txt
            echo "Notebook ${{ matrix.notebook.name }} converted successfully."
          else
            echo "FAILED" > results-${{ matrix.notebook.name }}.txt
            echo "Notebook ${{ matrix.notebook.name }} HTML conversion failed."
            exit 1
          fi
        else
          echo "FAILED" > results-${{ matrix.notebook.name }}.txt
          echo "Notebook ${{ matrix.notebook.name }} execution failed."
          exit 1
        fi

    - name: Upload HTML artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: html-r-${{ matrix.notebook.name }}
        path: html_output/*.html

    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: notebook-results-r-${{ matrix.notebook.name }}
        path: results-${{ matrix.notebook.name }}.txt

  check-results:
    runs-on: ubuntu-latest
    needs: [convert-python-notebooks, convert-r-notebooks]
    if: always()
    outputs:
      all-successful: ${{ steps.check.outputs.all-successful }}
    steps:
    - name: Gather all notebook results
      uses: actions/download-artifact@v4
      with:
        path: results/

    - id: check
      name: Check notebook results
      run: |
        echo "Checking notebook conversion results..."
        
        find results/ -name "results-*.txt" -exec cat {} \;
        
        FAILED_COUNT=$(find results/ -name "results-*.txt" -exec grep -l "FAILED" {} \; | wc -l)
        TOTAL_COUNT=$(find results/ -name "results-*.txt" | wc -l)
        
        echo "Total notebooks: $TOTAL_COUNT"
        echo "Failed notebooks: $FAILED_COUNT"
        
        if [ "$FAILED_COUNT" -gt 0 ]; then
          echo "❌ $FAILED_COUNT out of $TOTAL_COUNT notebooks failed conversion."
          find results/ -name "results-*.txt" -exec grep -l "FAILED" {} \; | while read file; do
            notebook_name=$(basename "$file" | sed 's/results-\(.*\)\.txt/\1/')
            echo "Failed notebook: $notebook_name"
          done
          echo "all-successful=false" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "✅ All $TOTAL_COUNT notebooks converted successfully!"
          echo "all-successful=true" >> $GITHUB_OUTPUT
        fi

  deploy:
    runs-on: ubuntu-latest
    needs: [check-results]
    if: needs.check-results.outputs.all-successful == 'true'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download all HTML artifacts
      uses: actions/download-artifact@v4
      with:
        path: html-artifacts/

    - name: Prepare Pages content
      run: |
        mkdir -p _site
        
        # Copy the NMDC logo to the site directory
        cp .github/workflows/nmdc_logo.png _site/
        
        # Move all HTML files to _site directory, organizing by source
        # Python notebooks come from html-python-* artifacts
        # R notebooks come from html-r-* artifacts
        find html-artifacts/html-python-* -name "*.html" 2>/dev/null -exec cp {} _site/ \; || true
        find html-artifacts/html-r-* -name "*.html" 2>/dev/null -exec cp {} _site/ \; || true
        
        # Create lists of notebooks by language based on artifact directories
        python_notebooks=$(find html-artifacts/html-python-* -name "*.html" 2>/dev/null | xargs -n1 basename | sort || true)
        r_notebooks=$(find html-artifacts/html-r-* -name "*.html" 2>/dev/null | xargs -n1 basename | sort || true)
        
        # Create an index.html with links to all notebooks
        cat > _site/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>NMDC Metadata Exploration</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    max-width: 900px;
                    margin: 0 auto;
                    padding: 40px 20px;
                    line-height: 1.6;
                    background: #f5f5f5;
                }
                .container {
                    background: white;
                    padding: 40px;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .header {
                    display: flex;
                    align-items: center;
                    margin-bottom: 20px;
                }
                .logo {
                    width: 80px;
                    height: 80px;
                    margin-right: 20px;
                }
                .title-section {
                    flex: 1;
                }
                h1 {
                    color: #333;
                    margin: 0;
                    padding-bottom: 10px;
                    font-size: 32px;
                }
                .subtitle {
                    color: #666;
                    font-size: 18px;
                    margin-top: 8px;
                }
                .subtitle a {
                    color: #007acc;
                    text-decoration: none;
                    border-bottom: 1px solid transparent;
                    transition: border-color 0.3s;
                }
                .subtitle a:hover {
                    border-bottom-color: #007acc;
                }
                .divider {
                    border-bottom: 3px solid #007acc;
                    margin: 20px 0 30px 0;
                }
                h2 {
                    color: #555;
                    margin-top: 40px;
                    margin-bottom: 20px;
                    font-size: 24px;
                }
                ul {
                    list-style: none;
                    padding: 0;
                }
                li {
                    margin: 12px 0;
                }
                a.notebook-link {
                    color: #007acc;
                    text-decoration: none;
                    font-size: 16px;
                    display: inline-block;
                    padding: 12px 20px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    transition: all 0.3s;
                    width: 100%;
                    box-sizing: border-box;
                }
                a.notebook-link:hover {
                    background-color: #007acc;
                    color: white;
                    border-color: #007acc;
                    transform: translateX(5px);
                }
                .language-badge {
                    display: inline-block;
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-left: 10px;
                }
                .python {
                    background: #3776ab;
                    color: white;
                }
                .r {
                    background: #276DC3;
                    color: white;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <img src="nmdc_logo.png" alt="NMDC Logo" class="logo">
                    <div class="title-section">
                        <h1>NMDC Metadata Exploration</h1>
                        <div class="subtitle">Using Jupyter Notebooks and the <a href="https://api.microbiomedata.org/docs" target="_blank" rel="noopener noreferrer">NMDC Runtime API</a></div>
                    </div>
                </div>
                <div class="divider"></div>
                
                <h2>Python Notebooks</h2>
                <ul>
        EOF
        
        # Add Python notebook links
        echo "$python_notebooks" | while read -r filename; do
          if [ -n "$filename" ]; then
            name="${filename%.*}"
            # Get display_name from config, fallback to generated name if not found
            display_name=$(jq -r --arg name "$name" '.python_notebooks[] | select(.name == $name) | .display_name // empty' .github/notebooks-config.json)
            if [ -z "$display_name" ]; then
              display_name=$(echo "$name" | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')
            fi
            echo "                <li><a href=\"$filename\" class=\"notebook-link\">$display_name <span class=\"language-badge python\">Python</span></a></li>" >> _site/index.html
          fi
        done
        
        cat >> _site/index.html << 'EOF'
                </ul>
                
                <h2>R Notebooks</h2>
                <ul>
        EOF
        
        # Add R notebook links
        echo "$r_notebooks" | while read -r filename; do
          if [ -n "$filename" ]; then
            name="${filename%.*}"
            # Remove "-r" suffix from name to match config
            config_name=$(echo "$name" | sed 's/-r$//')
            # Get display_name from config, fallback to generated name if not found
            display_name=$(jq -r --arg name "$config_name" '.r_notebooks[] | select(.name == $name) | .display_name // empty' .github/notebooks-config.json)
            if [ -z "$display_name" ]; then
              display_name=$(echo "$name" | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')
            fi
            echo "                <li><a href=\"$filename\" class=\"notebook-link\">$display_name <span class=\"language-badge r\">R</span></a></li>" >> _site/index.html
          fi
        done
        
        cat >> _site/index.html << 'EOF'
                </ul>
            </div>
        </body>
        </html>
        EOF

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4