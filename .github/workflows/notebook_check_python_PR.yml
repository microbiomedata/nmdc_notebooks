name: Execute modified python notebooks on PR

on:
  pull_request:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-notebooks: ${{ steps.find-changes.outputs.changed-notebooks }}
      has-changes: ${{ steps.find-changes.outputs.has-changes }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect changed notebooks
      id: find-changes
      run: |
        # Check if config file exists and debug
        if [ ! -f ".github/notebooks-config.json" ]; then
          echo "ERROR: Configuration file .github/notebooks-config.json not found"
          ls -la .github/
          exit 1
        fi
        
        # Validate JSON syntax
        if ! jq empty .github/notebooks-config.json; then
          echo "ERROR: Invalid JSON in configuration file"
          cat .github/notebooks-config.json
          exit 1
        fi
        
        # Initialize changed_notebooks as valid JSON
        changed_notebooks="[]"
        has_changes=false

        # Get list of changed files
        changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        
        # Use jq to iterate through notebooks more safely
        while IFS= read -r notebook_info; do
          name=$(echo "$notebook_info" | cut -d'|' -f1)
          path=$(echo "$notebook_info" | cut -d'|' -f2)
          
          if echo "$changed_files" | grep -q "$path"; then
            changed_notebooks=$(echo "$changed_notebooks" | jq --arg name "$name" --arg path "$path" '. += [{"name": $name, "path": $path}]')
            has_changes=true
            echo "✓ Notebook $name needs testing"
          fi
        done < <(jq -r '.python_notebooks[] | "\(.name)|\(.path)"' .github/notebooks-config.json)

        # Write compact JSON to outputs
        echo "changed-notebooks=$(echo "$changed_notebooks" | jq -c .)" >> $GITHUB_OUTPUT
        echo "has-changes=$has_changes" >> $GITHUB_OUTPUT

  setup:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install jupyter

  execute-notebooks:
    runs-on: ubuntu-latest
    needs: [detect-changes, setup]
    continue-on-error: true
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        notebook: ${{ fromJson(needs.detect-changes.outputs.changed-notebooks) }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Restore cache
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install jupyter

    - name: Execute notebook
      run: |
        echo "Executing notebook: ${{ matrix.notebook.path }}"
        set +e  # Don't exit on error immediately
        jupyter nbconvert --execute --to notebook --inplace "${{ matrix.notebook.path }}"
        EXIT_CODE=$?
        set -e  # Re-enable exit on error
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo "❌ Notebook execution failed with exit code $EXIT_CODE"
          echo "FAILED" > results-${{ matrix.notebook.name }}.txt
          exit 1  # Fail this step
        else
          echo "✅ Notebook executed successfully"
          echo "SUCCESS" > results-${{ matrix.notebook.name }}.txt
        fi

    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: notebook-results-${{ matrix.notebook.name }}
        path: results-${{ matrix.notebook.name }}.txt

    - name: Upload result
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: result-${{ matrix.notebook.name }}
        path: ${{ matrix.notebook.path }}

  check-results:
    runs-on: ubuntu-latest
    needs: [detect-changes, execute-notebooks]
    if: always() && needs.detect-changes.outputs.has-changes == 'true'
    steps:
    - name: Gather all notebook results
      uses: actions/download-artifact@v4
      with:
        path: results/

    - name: Check notebook results
      run: |
        echo "Checking notebook execution results..."
        
        find results/ -name "results-*.txt" -exec cat {} \;
        
        FAILED_COUNT=$(find results/ -name "results-*.txt" -exec grep -l "FAILED" {} \; | wc -l)
        TOTAL_COUNT=$(find results/ -name "results-*.txt" | wc -l)
        
        echo "Total notebooks: $TOTAL_COUNT"
        echo "Failed notebooks: $FAILED_COUNT"
        
        if [ "$FAILED_COUNT" -gt 0 ]; then
          echo "❌ $FAILED_COUNT out of $TOTAL_COUNT notebooks failed execution."
          find results/ -name "results-*.txt" -exec grep -l "FAILED" {} \; | while read file; do
            notebook_name=$(basename "$file" | sed 's/results-\(.*\)\.txt/\1/')
            echo "Failed notebook: $notebook_name"
          done
          exit 1
        else
          echo "✅ All $TOTAL_COUNT notebooks executed successfully!"
        fi

  no-changes:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'false'
    steps:
    - name: No changes detected
      run: |
        echo "✅ No Python notebooks were changed in this PR. Skipping execution."