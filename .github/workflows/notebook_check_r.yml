name: Execute R notebooks

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
  # run once a week
  schedule:
    - cron: "0 0 * * 0"

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      notebooks: ${{ steps.set-notebooks.outputs.notebooks }}
    steps:
    - id: checkout
      uses: actions/checkout@v4

    - id: python-setup
      name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - id: install-jupyter
      name: Install Jupyter
      run: |
        python -m pip install --upgrade pip
        pip install jupyter

    - id: r-setup
      name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'

    - name: Install system dependencies on Linux
      if: runner.os == 'Linux'
      run: sudo apt-get install -y make libicu-dev libxml2-dev libssl-dev pandoc librdf0-dev libnode-dev libcurl4-gnutls-dev libpng-dev

    - id: r-dependencies
      name: Install R dependencies
      run: |
        R -e 'install.packages("renv")'
        R -e 'renv::restore()'
        R -e 'install.packages("IRkernel")'
        R -e 'IRkernel::installspec()'

    # Cache R packages for parallel jobs
    - name: Cache R packages
      uses: actions/cache@v3
      with:
        path: ~/.local/share/renv
        key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}
        restore-keys: |
          ${{ runner.os }}-renv-

    - id: set-notebooks
      name: Set notebook matrix
      run: |
        echo 'notebooks=[{"name": "bioscales", "path": "bioscales_biogeochemical_metadata/R/bioscales_metadata.ipynb"}, {"name": "neon", "path": "NEON_soil_metadata/R/NEON_data_exploration.ipynb"}, {"name": "taxonomic", "path": "taxonomic_dist_by_soil_layer/R/taxonomic_dist_soil_layer_R.ipynb"}, {"name": "nom", "path": "NOM_visualizations/R/NOM_R_notebook.ipynb"}]' >> $GITHUB_OUTPUT

  execute-notebooks:
    runs-on: ubuntu-latest
    needs: setup
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        notebook: ${{ fromJson(needs.setup.outputs.notebooks) }}
    outputs:
      result: ${{ steps.execute.outcome }}
      notebook-name: ${{ matrix.notebook.name }}
    
    steps:
    - id: checkout
      uses: actions/checkout@v4

    - id: python-setup
      name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - id: install-jupyter
      name: Install Jupyter
      run: |
        python -m pip install --upgrade pip
        pip install jupyter

    - id: r-setup
      name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'

    - name: Install system dependencies on Linux
      if: runner.os == 'Linux'
      run: sudo apt-get install -y make libicu-dev libxml2-dev libssl-dev pandoc librdf0-dev libnode-dev libcurl4-gnutls-dev libpng-dev

    - name: Restore R packages cache
      uses: actions/cache@v3
      with:
        path: ~/.local/share/renv
        key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}
        restore-keys: |
          ${{ runner.os }}-renv-

    - id: r-dependencies
      name: Install R dependencies
      run: |
        R -e 'install.packages("renv")'
        R -e 'renv::restore()'
        R -e 'install.packages("IRkernel")'
        R -e 'IRkernel::installspec()'

    - id: execute
      name: Execute ${{ matrix.notebook.name }} notebook
      run: |
        echo "Executing notebook: ${{ matrix.notebook.path }}"
        jupyter nbconvert --execute --to notebook --inplace "${{ matrix.notebook.path }}"
        echo "Successfully executed ${{ matrix.notebook.name }} notebook"

    # Save execution result for the summary job
    - name: Save result
      if: always()
      run: |
        mkdir -p results
        if [ "${{ steps.execute.outcome }}" == "success" ]; then
          echo "SUCCESS" > results/${{ matrix.notebook.name }}.txt
        else
          echo "FAILED" > results/${{ matrix.notebook.name }}.txt
        fi

    - name: Upload results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: notebook-results-${{ matrix.notebook.name }}
        path: results/

  summary:
    runs-on: ubuntu-latest
    needs: execute-notebooks
    if: always()
    steps:
    - name: Download all results
      uses: actions/download-artifact@v4
      with:
        pattern: notebook-results-*
        path: results/
        merge-multiple: true

    - name: Generate summary
      run: |
        echo "## R Notebook Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        success_count=0
        failed_count=0
        failed_notebooks=""
        
        for result_file in results/*.txt; do
          if [ -f "$result_file" ]; then
            notebook_name=$(basename "$result_file" .txt)
            result=$(cat "$result_file")
            
            if [ "$result" == "SUCCESS" ]; then
              echo "âœ… **$notebook_name**: SUCCESS" >> $GITHUB_STEP_SUMMARY
              ((success_count++))
            else
              echo "âŒ **$notebook_name**: FAILED" >> $GITHUB_STEP_SUMMARY
              ((failed_count++))
              if [ -z "$failed_notebooks" ]; then
                failed_notebooks="$notebook_name"
              else
                failed_notebooks="$failed_notebooks, $notebook_name"
              fi
            fi
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total**: $((success_count + failed_count)) notebooks" >> $GITHUB_STEP_SUMMARY
        echo "**Successful**: $success_count" >> $GITHUB_STEP_SUMMARY
        echo "**Failed**: $failed_count" >> $GITHUB_STEP_SUMMARY
        
        if [ $failed_count -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Failed notebooks**: $failed_notebooks" >> $GITHUB_STEP_SUMMARY
          echo "failed_notebooks=$failed_notebooks" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **All R notebooks executed successfully!**" >> $GITHUB_STEP_SUMMARY
        fi